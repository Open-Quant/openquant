---
import Layout from "../layouts/Layout.astro";
import { moduleDocs } from "../data/moduleDocs";
import { chapterCoverage } from "../data/afmlDocs";

const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL.slice(0, -1)
  : import.meta.env.BASE_URL;
const chapters = chapterCoverage();
const modulesByName = new Map(moduleDocs.map((doc) => [doc.module, doc]));
---
<Layout title="Subjects (AFML) â€¢ OpenQuant-rs" description="AFML-style subject map with dedicated pages for each OpenQuant module.">
  <section class="hero">
    <h1>Subjects (AFML-Aligned)</h1>
    <p class="muted">Section-by-section AFML hierarchy with module-level pages, formulas, API surfaces, and implementation examples.</p>
  </section>

  {chapters.map((chapter) => (
    <section>
      <h2>{chapter.chapter}</h2>
      <p class="muted">{chapter.theme}</p>
      <table>
        <thead>
          <tr>
            <th>Module</th>
            <th>Subject</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {chapter.sections.map((section) => {
            const doc = modulesByName.get(section.module);
            if (!doc) {
              return (
                <tr>
                  <td>{section.module}</td>
                  <td class="muted">missing from moduleDocs.ts</td>
                  <td>{section.status}</td>
                </tr>
              );
            }

            return (
              <tr>
                <td><a href={`${base}/module/${doc.slug}`}>{doc.module}</a></td>
                <td>{doc.subject}</td>
                <td>{section.status}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
      <div class="grid">
        {chapter.sections.map((section) => {
          const doc = modulesByName.get(section.module);
          if (!doc) {
            return null;
          }
          return (
          <article class="card">
            <h3><a href={`${base}/module/${doc.slug}`}>{doc.module}</a></h3>
            <p class="muted">{doc.summary}</p>
            <p class="muted">{doc.subject}</p>
          </article>
          );
        })}
      </div>
    </section>
  ))}
</Layout>
